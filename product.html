<script>
  // ✅ API Gateway 엔드포인트 (POST /payment)
  const API_GATEWAY_URL = "https://8jmfvgtqzk.execute-api.ap-northeast-2.amazonaws.com/dev/payment";

  window.addEventListener("DOMContentLoaded", function(){
    const loggedIn = localStorage.getItem("loggedIn") === "true";
    const userId = localStorage.getItem("userId");

    if(!loggedIn || !userId){
      window.location.replace("login.html");
      return;
    }

    sessionStorage.removeItem("paid");
    sessionStorage.removeItem("last_order_id");

    if(userId !== "testuser"){
      const payBtn = document.getElementById("payBtn");
      if(payBtn){
        payBtn.disabled = true;
        payBtn.style.opacity = "0.5";
        document.getElementById("noteText").innerText =
          "⚠️ 현재는 테스트 계정(testuser)으로만 결제가 가능합니다.";
      }
    }
  });

  function logout(e){
    e.preventDefault();
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("userId");
    sessionStorage.clear();

    alert("로그아웃 되었습니다.");
    window.location.href = "index.html";
  }

  async function startPayment(){
    const orderId = "order_" + Date.now();

    try {
      // ✅ API Gateway → Lambda 호출
      const response = await fetch(API_GATEWAY_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ amount: 9900 })
      });

      const data = await response.json();
      console.log("결제 API 응답:", data);

      // ✅ Payple 응답 체크
      if(data && data.result === "success"){
        sessionStorage.setItem("paid", "true");
        sessionStorage.setItem("last_order_id", orderId);
        alert("결제가 완료되었습니다!");
        window.location.href = "success.html";
      } else {
        alert("결제 실패: " + JSON.stringify(data));
      }

    } catch (err) {
      console.error("결제 에러:", err);
      alert("결제 요청 중 오류가 발생했습니다.");
    }
  }
</script>
